(function(){var e,n,t,r,s;s=require("through2"),r=require("path"),n=require("bluebird"),t={removeVarDef:function(e,n,t){var r,s,i,a;return n.length>0&&t>0&&(a=/^var\s+(([\w\d]+,\s*)+[\w\d]+)(;|\s*=)/.exec(e.substring(0,t)))&&(s=a[3],r=a[1].split(/,\s*/),";"!==s&&(s=r.pop()+s),r=r.filter(function(e){return!n.includes(e)}),";"!==s&&r.length>0&&(s=", "+s),i="var "+r.join(", ")+s,"var ;"===i&&(i=""),e=e.substring(0,a.index)+i+e.substring(a.index+a[0].length)),e},extractDependencies:function(e){var n,r,s,i,a,c,o,p,u;if(null,r=[],u=null,(p=/(\/\/|\/\*+|###)\s*dependencies\s*(\*+\/|###)?/i.exec(e))&&(s=/(\/\/|\/\*+|###)\s*end\s*dependencies\s*(\*+\/|###)?/i.exec(e)))r=e.substring(p.index+p[0].length,s.index).trim().split("\n"),r=r.filter(function(e){return""!==e.trim()}),e=e.substring(0,p.index)+e.substring(s.index+s[0].length),u=p.index;else{for(c=e.split("\n"),i=0;;)if(a=c[i],(o=a.match(/^((var|const)\s+)?(\w+)\s*=.*require.*$/))&&(0===r.length&&(u=c.slice(0,i).join("\n").length),r.push(a),c.splice(i,1)),""===a.trim()?(o=!0,c.splice(i,1)):i++,i>=c.length||r.length>0&&!o)break;e=c.join("\n")}return n=r.map(function(e){if(null==(o=e.match(/^((var|const)\s+)?(\w+)\s*=\s*/)))throw new Error("spark-wraper: malformated dependency :"+e);return{name:o[3],def:e.substring(o[0].length)}}),e=t.removeVarDef(e,n.map(function(e){return e.name}),u),{contents:e,dependencies:n}},replaceOptions:function(e,n){return n.replace(/\{\{className\}\}/g,e.className).replace(/\{\{namespace\}\}/g,e.namespace)},wrap:function(e,r){var s;return s=[],n.resolve().then(function(){var e;return e=t.extractDependencies(r),r=e.contents,s=e.dependencies}).then(function(){var n,i,a,c,o;if(i='(function(definition){ {{className}} = definition(typeof({{namespace}}) !== "undefined"?{{namespace}}:this.{{namespace}}); {{className}}.definition = definition; if (typeof(module) !== "undefined" && module !== null) { module.exports = {{className}}; } else { if (typeof({{namespace}}) !== "undefined" && {{namespace}} !== null) { {{namespace}}.Tile.{{className}} = {{className}}; } else{ if (this.{{namespace}} == null) { this.{{namespace}} = {}; } this.{{namespace}}.Tile.{{className}} = {{className}}; } } })(',i=t.replaceOptions(e,i).replace(/\s/g,""),s.length)for(i+="function(dependencies){if(dependencies==null){dependencies={};}",c=0,o=s.length;c<o;c++)a=s[c],i+='\nvar {{name}} = dependencies.hasOwnProperty("{{name}}") ? dependencies.{{name}} : {{def}}'.replace(/\{\{name\}\}/g,a.name).replace(/\{\{def\}\}/g,a.def);else i+="function(){";return n=t.replaceOptions(e,"return({{className}}); });").replace(/\s/g,""),i+"\n"+r+"\n"+n})},doWrap:function(e,n){return function(t,s,i){var a,c,o;return this,o=Object.assign({},e),c=t.contents&&"function"==typeof t.contents.on&&"function"==typeof t.contents.pipe,a=t.contents instanceof Buffer,null==(null!=o?o.namespace:void 0)&&i(new Error("spark-wraper: namespace needed"),t),c?i(new Error("spark-wraper: Streaming not supported"),t):a?(null==o.className&&(o.className=r.basename(t.path,r.extname(t.path))),n(o,String(t.contents)).then(function(e){return t.contents=new Buffer(e),t}).asCallback(i)):i(null,t)}}},e=function(){function e(e){this.options=Object.assign({},e),this.files=[],this.processed=[]}return e.prototype.collect=function(e,t){return this.files.push(e),n.resolve()},e.prototype.processFile=function(e,t){var r;return r=this.files.indexOf(e),r>-1?this.wrapFile(e,t).then(function(e){return function(n){return e.files.splice(r,1),t.push(n),e.processed.push(n),n}}(this)):n.reject(new Error("this file is not in the stream"))},e.prototype.getProcessedFile=function(e,t){return n.resolve().then(function(n){return function(){var r;return(r=n.files.find(function(n){return n.path===e}))?n.processFile(r,t):(r=n.processed.find(function(n){return n.path===e}))?r:void 0}}(this))},e.prototype.resolveDependency=function(e,s,i){return n.resolve().then(function(n){return function(){var t,a;if(a=/require(\(|\s*)['"]([^'"]+)['"]\)?/.exec(e.def))return t=r.resolve(r.dirname(s.path)+"/"+a[2]+r.extname(s.path)),n.getProcessedFile(t,i).then(function(n){if(n)return e.def=e.def.replace(a[0],n.wraped.namespace+"."+n.wraped.className)})}}(this)).then(function(n){return function(){return t.replaceOptions(n.options,'\n  {{name}} = if dependencies.hasOwnProperty("{{name}}") then dependencies.{{name}} else {{def}}'.replace(/\{\{def\}\}/g,e.def).replace(/\{\{name\}\}/g,e.name))}}(this))},e.prototype.wrapFile=function(e,s){return n.resolve().then(function(i){return function(){var a,c,o,p;if(null==e.wraped)return e.wraped={className:r.basename(e.path,r.extname(e.path)),namespace:i.options.namespace},c=String(e.contents),p=t.extractDependencies(c),c=p.contents,o=p.dependencies,a="((definition)->\n  {{namespace}}.{{className}} = definition()\n  {{namespace}}.{{className}}.definition = definition\n)(",o.length?a+="(dependencies={})->":a+="->",a=t.replaceOptions(e.wraped,a),n.map(o,function(n){return i.resolveDependency(n,e,s)}).then(function(n){var r,s,i,o;for(i=0,o=n.length;i<o;i++)s=n[i],a+=s;return r=t.replaceOptions(e.wraped,"  {{className}}\n)"),c=a+"\n"+c.replace(/^/gm,"  ")+"\n"+r,e.contents=new Buffer(c)})}}(this)).then(function(n){return function(){return e}}())},e.prototype.compose=function(e){if(this.files.length)return this.processFile(this.files[0],e).then(function(n){return function(){return n.compose(e)}}(this))},e.prototype.getStream=function(){var e;return e=this,s.obj(function(n,t,r){return e.collect(n,this).asCallback(r)},function(n){return e.compose(this).asCallback(n)})},e}(),module.exports=function(e){return s.obj(t.doWrap(e,t.wrap))},module.exports.compose=function(n){var t;return t=new e(n),t.getStream()},module.exports.fn=t}).call(this);