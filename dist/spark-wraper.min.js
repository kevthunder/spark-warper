(function(){var e,n,r;e=require("event-stream"),r=require("path"),n={removeVarDef:function(e,n,r){var t,a,s,i;return n.length>0&&r>0&&(i=/^var\s+(([\w\d]+,\s*)+[\w\d]+)(;|\s*=)/.exec(e.substring(0,r)))&&(a=i[3],t=i[1].split(/,\s*/),";"!==a&&(a=t.pop()+a),t=t.filter(function(e){return!n.includes(e)}),";"!==a&&t.length>0&&(a=", "+a),s="var "+t.join(", ")+a,"var ;"===s&&(s=""),e=e.substring(0,i.index)+s+e.substring(i.index+i[0].length)),e},extractDependencies:function(e,r){var t,a,s,i,c,l,p,u,o,d;if(i=null,a=[],d=null,(o=/(\/\/|\/\*+)\s*dependencies\s*(\*+\/)?/i.exec(e))&&(s=/(\/\/|\/\*+)\s*end\s*dependencies\s*(\*+\/)?/i.exec(e)))a=e.substring(o.index+o[0].length,s.index).trim().split("\n"),a=a.filter(function(e){return""!==e.trim()}),e=e.substring(0,o.index)+e.substring(s.index+s[0].length),d=o.index;else{for(p=e.split("\n"),c=0;;)if(l=p[c],(u=l.match(/^((var|const)\s+)?(\w+)\s*=.*require.*$/))&&(0===a.length&&(d=p.slice(0,c).join("\n").length),a.push(l),p.splice(c,1)),""===l.trim()?(u=!0,p.splice(c,1)):c++,c>=p.length||a.length>0&&!u)break;e=p.join("\n")}return t=a.map(function(e){return u=e.match(/^((var|const)\s+)?(\w+)\s*=\s*/),null==u?i=new Error("spark-wraper: malformated dependency :"+e):{name:u[3],def:e.substring(u[0].length)}}),e=n.removeVarDef(e,t.map(function(e){return e.name}),d),r(i,e,t)},replaceOptions:function(e,n){return n.replace(/\{\{className\}\}/g,e.className).replace(/\{\{namespace\}\}/g,e.namespace)},wrap:function(e,r,t){return n.extractDependencies(r,function(r,a,s){var i,c,l,p,u;if(r)return t(r);for(c=n.replaceOptions(e,'(function(definition){ {{className}} = definition(typeof({{namespace}}) !== "undefined"?{{namespace}}:this.{{namespace}}); {{className}}.definition = definition; if (typeof(module) !== "undefined" && module !== null) { module.exports = {{className}}; } else { if (typeof({{namespace}}) !== "undefined" && {{namespace}} !== null) { {{namespace}}.Tile.{{className}} = {{className}}; } else{ if (this.{{namespace}} == null) { this.{{namespace}} = {}; } this.{{namespace}}.Tile.{{className}} = {{className}}; } } })(function(dependencies) {if(dependencies==null){dependencies={};}').replace(/\s/g,""),p=0,u=s.length;p<u;p++)l=s[p],c+='\nvar {{name}} = dependencies.hasOwnProperty("{{name}}") ? dependencies.{{name}} : {{def}}'.replace(/\{\{name\}\}/g,l.name).replace(/\{\{def\}\}/g,l.def);return i=n.replaceOptions(e,"return({{className}}); });").replace(/\s/g,""),t(null,c+"\n"+a+"\n"+i)})},doWrap:function(e,n){return function(t,a){var s,i;return i=t.contents&&"function"==typeof t.contents.on&&"function"==typeof t.contents.pipe,s=t.contents instanceof Buffer,null==(null!=e?e.namespace:void 0)&&a(new Error("spark-wraper: namespace needed"),t),i?a(new Error("spark-wraper: Streaming not supported"),t):s?(null==e.className&&(e.className=r.basename(t.path,r.extname(t.path))),n(e,String(t.contents),function(e,n){return e?a(e,t):(t.contents=new Buffer(n),a(null,t))})):a(null,t)}}},module.exports=function(r){return e.map(n.doWrap(r,n.wrap))},module.exports.wrapPart=function(r){return e.map(n.doWrap(r,n.wrapPart))},module.exports.fn=n}).call(this);